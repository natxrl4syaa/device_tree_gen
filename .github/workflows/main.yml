name: Ultimate Device Tree + Vendor (Auto Partition Sizes)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Direct URL to flashable ROM zip (HyperOS)'
        required: true
      device_codename:
        description: 'Your device codename (e.g., degas)'
        required: true
        default: 'degas'
      reference_repo:
        description: 'GitHub reference tree (e.g., mt6897-devs/device_xiaomi_duchamp)'
        required: true
        default: 'mt6897-devs/device_xiaomi_duchamp'
      reference_branch:
        description: 'Reference branch (e.g., lineage-23.2)'
        required: true
        default: 'lineage-23.2'

jobs:
  ultimate-generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo (workflow only)
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-pip wget unzip erofs-utils \
            squashfs-tools lz4 lzop xz-utils zstd android-sdk-libsparse-utils \
            p7zip-full brotli cpio e2fsprogs git rsync
          pip3 install dumpyara aospdtgen M2Crypto

      - name: Download ROM
        run: wget -O rom.zip "${{ github.event.inputs.rom_url }}"

      # Extract payload.bin for partition info
      - name: Extract payload.bin from ROM zip
        run: |
          unzip -j rom.zip "payload.bin" -d . || { echo "payload.bin not found at root, searching..."; unzip -l rom.zip | grep payload.bin || { echo "payload.bin not found in ROM zip!"; exit 1; }; PAYLOAD_PATH=$(unzip -l rom.zip | grep -oE "[^ ]+payload\.bin" | head -1); unzip -j rom.zip "$PAYLOAD_PATH" -d .; }
          ls -lh payload.bin

      # Download and run payload-dumper-go to list partitions
      - name: Download payload-dumper-go
        run: |
          wget -O payload-dumper-go.tar.gz https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -xzf payload-dumper-go.tar.gz
          chmod +x payload-dumper-go

      - name: Get partition sizes from payload.bin
        id: partition_info
        run: |
          ./payload-dumper-go list payload.bin > partition_list.txt
          cat partition_list.txt
          # Parse the output to extract sizes for key partitions
          # We'll create a script to parse and generate BoardConfig.mk snippet
          python3 <<EOF
          import re
          sizes = {}
          with open('partition_list.txt') as f:
              for line in f:
                  # Example line: "system            : 1234567890 bytes"
                  match = re.search(r'^([a-zA-Z0-9_]+)\s*:\s*(\d+)\s+bytes', line)
                  if match:
                      name = match.group(1)
                      size = match.group(2)
                      sizes[name] = size
          # Define the variables we care about
          var_map = {
              'BOARD_SUPER_PARTITION_SIZE': 'super',
              'BOARD_BOOTIMAGE_PARTITION_SIZE': 'boot',
              'BOARD_DTBOIMG_PARTITION_SIZE': 'dtbo',
              'BOARD_VENDOR_BOOTIMAGE_PARTITION_SIZE': 'vendor_boot',
              'BOARD_INIT_BOOT_IMAGE_PARTITION_SIZE': 'init_boot',
          }
          with open('partition_sizes.mk', 'w') as out:
              for var, part in var_map.items():
                  if part in sizes:
                      out.write(f"{var} := {sizes[part]}\n")
                  else:
                      # If not found, leave as TODO
                      out.write(f"# TODO: {var} not found – set manually\n")
          EOF
          cat partition_sizes.mk

      - name: Generate system dump with dumpyara
        run: |
          mkdir dump
          dumpyara -o dump rom.zip

      - name: Generate device tree with aospdtgen
        run: |
          mkdir -p device_tree
          python3 -m aospdtgen dump/ -o device_tree/

      - name: Clone reference repository
        run: |
          git clone --branch ${{ github.event.inputs.reference_branch }} https://github.com/${{ github.event.inputs.reference_repo }}.git reference

      - name: Copy essential folders from reference into device tree
        run: |
          # Locate the generated device tree (often under device_tree/device/xiaomi/generic)
          if [ -d "device_tree/device/xiaomi/generic" ]; then
            TARGET_DIR="device_tree/device/xiaomi/generic"
          else
            TARGET_DIR="device_tree"
          fi
          echo "Target directory: $TARGET_DIR"
          cd "$TARGET_DIR"

          for folder in power sensors lights parts overlay overlay-lineage sepolicy udfps vintf configs include libshims blob-patches; do
            if [ -d "../../../reference/$folder" ]; then
              cp -r "../../../reference/$folder" ./ && echo "Copied $folder"
            else
              echo "Skipping $folder (not found in reference)"
            fi
          done

          cp ../../../reference/extract-files.py ./ 2>/dev/null || true
          cp ../../../reference/setup-makefiles.py ./ 2>/dev/null || true

      - name: Replace codename in all files
        run: |
          if [ -d "device_tree/device/xiaomi/generic" ]; then
            cd device_tree/device/xiaomi/generic
          else
            cd device_tree
          fi
          find . -type f -exec sed -i "s/duchamp/${{ github.event.inputs.device_codename }}/g" {} \;
          find . -type f -exec sed -i "s|device/xiaomi/generic|device/xiaomi/${{ github.event.inputs.device_codename }}|g" {} \;

      # Apply partition sizes to BoardConfig.mk
      - name: Apply partition sizes to BoardConfig.mk
        run: |
          if [ -d "device_tree/device/xiaomi/generic" ]; then
            cd device_tree/device/xiaomi/generic
          else
            cd device_tree
          fi
          # Backup original
          cp BoardConfig.mk BoardConfig.mk.bak
          # Remove existing size lines (optional) and append our generated ones
          # We'll just replace the TODO lines with actual values
          while IFS= read -r line; do
            if [[ $line == \#\ TODO:\ FILL\ CORRECT\ VALUE* ]]; then
              # Skip – will be replaced
              continue
            fi
            echo "$line" >> BoardConfig.mk.new
          done < BoardConfig.mk
          # Append our partition sizes
          cat ${{ github.workspace }}/partition_sizes.mk >> BoardConfig.mk.new
          # Add a note
          echo "# Partition sizes auto-filled from payload.bin" >> BoardConfig.mk.new
          mv BoardConfig.mk.new BoardConfig.mk
          # Show diff for debugging
          diff BoardConfig.mk.bak BoardConfig.mk || true

      - name: Generate vendor tree using extract-files.py
        run: |
          if [ -d "device_tree/device/xiaomi/generic" ]; then
            cd device_tree/device/xiaomi/generic
          else
            cd device_tree
          fi
          chmod +x extract-files.py
          ./extract-files.py ${{ github.workspace }}/dump/
          if [ -d "../../../vendor/xiaomi/${{ github.event.inputs.device_codename }}" ]; then
            mkdir -p vendor
            mv ../../../vendor/xiaomi/${{ github.event.inputs.device_codename }} vendor/
            echo "Vendor tree moved to device_tree/vendor/"
          else
            echo "Vendor tree not found – extraction may have failed."
            exit 1
          fi

      - name: Final tree structure (for debugging)
        run: find device_tree -type d | head -50

      - name: Upload complete device + vendor as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.device_codename }}-full-tree
          path: device_tree/
